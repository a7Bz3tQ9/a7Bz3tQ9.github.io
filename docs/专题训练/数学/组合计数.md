### 错排

> 求有多少排列 $p_{1\sim n}$，使得 $\forall x\in[1,n],p_x\neq x$。

钦定 $i$ 个位置不满足的方案数为 $\binom n i (n-i)!$，二项式反演得：

$$
ans=\sum_{i=0}^n(-1)^i\times \binom n i (n-i)!=n!\sum_{i=0}^n\frac{(-1)^i}{i!}
$$

故 $a_n=a_{n-1}\times n+(-1)^n$，且 $a_1=0$。将其中一个 $a_{n-1}$ 改写成 $a_{n-2}\times (n-1)+(-1)^{n-1}$，可得：

$$
a_n=(n-1)(a_{n-1}+a_{n-2})
$$

意义：考虑新的数 $n$ 来的时候，若前 $n-1$ 个已经错排，任意交换一个即符合；若有 $n-2$ 个已经错排，和另一个放置正确的交换也符合，而放置正确的数有 $n-1$ 种情况。

### 十二试炼

$n$ 个 有标号/无标号 的球，分给 $m$ 个 有标号/无标号的盒子，盒子有三种限制：A. 无限制；B. 每个盒子至少有一个球；C. 每个盒子至多有一个球。

将有标号记为 L (Labelled)，无标号记为 U (Unlabelled)。

比如 ULA 表示 $n$ 个无标号的球分给 $m$ 个有标号的盒子的方案数。

- LL 型：考虑每个球放进哪个盒子，乘法原理。

  - LLA：

    1. $m^n$。

    2. LLB 枚举非空盒子数。
    
        $$
        \sum_{i=1}^m\binom m i\times \begin{Bmatrix}n\\i\end{Bmatrix}i!
        $$
    
  - LLB：

    1. 二项式反演：LLA 对空盒子容斥。

        $$
        \sum_{i=0}^m(-1)^{m-i}\binom m ii^n
        $$

    2. 第二类斯特林数：LUB 给盒子分配顺序。

        $$
        \begin{Bmatrix}
        n\\m
        \end{Bmatrix}
        m!
        $$

        注意使用 $\times m!$ 给盒子标号的前提条件是球有标号，因为任意两个盒子不标号也可以通过装的球去区分；而球无标号时，即使是非空盒子之间可能也无法区分，需要乘多重集排列，就不太现实了。

  - LLC：选出要放的盒子，ULB 给球分配顺序。
    
    $$
    \binom{m}{n}n!
    $$
    

- UL 型：将 $n$ 个球分成 $m$ 组，第 $i$ 组放进第 $i$ 个盒子，隔板法。

  - ULA：$x_1+x_2+\cdots+x_m=n\,(x_i\geq 0)$ 的解数。
    
    $$
    \binom{n+m-1}{m-1}
    $$

  - ULB：$x_1+x_2+\cdots+x_m=n\,(x_i\geq 1)$ 的解数。
    
    $$
    \binom{n-1}{m-1}
    $$

  - ULC：$x_1+x_2+\cdots+x_m=n\,(x_i\in\{0,1\})$ 的解数，选其中 $n$ 位是 $1$。
    
    $$
    \binom m n
    $$

- LU 型：第二类斯特林数。

  - LUA：LUB 枚举非空盒子数。
    
    $$
    \sum_{i=1}^m
    \begin{Bmatrix}n\\i\end{Bmatrix}
    $$

  - LUB：
    
    $$
    \begin{Bmatrix}n\\m\end{Bmatrix}
    $$

  - LUC：由于盒子无标号，钦定第 $i$ 个球放第 $i$ 个盒子（处理不标号的基本方法，手动将不标号的东西按某种方式排序后编号，使得相同方案的编号方式是相同的）。
    
    $$
    [n\leq m]
    $$

- UU 型：将 $n$ 个球划分成 $m$ 组，钦定第 $i$ 大的组放进第 $i$ 个盒子处理盒子无标号。整数划分问题。

  - UUA：设 $p_{i,j}$ 表示将 $i$ 划分成 $j$ 个非负整数的方案数。$p_{i,j}=p_{i,j-1}+p_{i-j,j}$。
    
    $$
    p_{n,m}
    $$

  - UUB：预先每组放一个球。
    
    $$
    p_{n-m,m}
    $$

  - UUC：
   
    $$
    [n\leq m]
    $$

技巧：

1. L 转 U：思考什么样的方案是相同的，人工制造一个排序方式并编号，使得相同方案的编号方式相同。
2. U 转 L：思考满足什么样关系的 U 是可以区分的，如果都能根据里面的东西区分直接乘阶乘，否则要乘多重集组合数不太好做。
3. A 转 B：容斥；预先每个盒子先放一个球。
4. B 转 A：枚举非空盒子数。
5. 直接推导难度较大，则使用 DP。

### 广义二项式系数

组合数 $\large\binom{n}{m}\normalsize=\large\frac{n!}{m!(n-m)!}$ 又称为二项式系数，因为 $\large\binom n m\normalsize=[x^m](1+x)^n$。当 $n$ 是自然数但 $n<m$ 时认为 $\large\binom n m\normalsize=0$。

将组合数的上指标 $n$ 由自然数扩展到任意实数（$m$ 始终是自然数），就得到了广义二项式系数：

$$
\binom{n}{m}=\frac{n(n-1)\cdots(n-m+1)}{m!}
$$

在该定义下，当 $n<m$ 且 $n$ 是自然数时有 $\large\binom n m \normalsize=0$，与之前的约定相同。

广义二项式定理：

$$
(x+y)^{\alpha}=\sum_{i=0}^{\infty}\binom{\alpha}{i}x^iy^{\alpha-i}\,(\alpha\in\mathbb R)
$$

### 多项式系数

多项式系数：$n$ 个不同物品划分成 $m$ 个集合，第 $i$ 个集合大小为 $a_i$，$\sum a_i=n$，求总方案数。

$$
\binom{n}{a_1,a_2,\cdots,a_m}=\prod_{i=1}^m\binom{a_i+\cdots+a_m}{a_i}=\prod_{i=1}^m \frac{(a_i+\cdots+a_m)!}{a_i!\times (a_{i+1}+\cdots+a_m)!}=\frac{n!}{a_1a_2\cdots a_m!}
$$

多项式定理：

$$
(\sum_{i=1}^n x_i)^n=\sum_{a_1+\cdots+a_m=n}\binom{n}{a_1,a_2,\cdots,a_m}\times \prod_{i=1}^n x_i^{a_i}
$$

### 组合恒等式

- 上指标求和：
  
  $$
  \sum_{i=0}^n\binom{i}{m}=\binom{n+1}{m+1}
  $$

- 对角线求和：
  
  $$
  \sum_{i=0}^n\binom{m+i}{i}=\binom{m+n+1}{n}
  $$
  > 证明：转上指标求和。
  > 
  > $$
  > =\sum_{i=m}^{n+m}\binom{i}{m}=\binom{n+m+1}{m+1}
  > $$
  
- 负对角线求和：
  
  $$
  \sum_{i=0}^{n}\binom{n-i}{i}=fib_{n+1}
  $$

  > 证明：$fib$ 就是每步走 $1$ 或 $2$，走到 $n$ 的方案数。枚举走了 $i$ 步 $2$，从总共的 $n-i$ 步中选 $i$ 步走 $2$。


- 范德蒙德卷积 / 下指标卷积：
  $$
  \sum_{i=0}^k\binom{n}{i}\binom{m}{k-i}=\binom{n+m}{k}
  $$

	首先上指标需要是定值，然后若下指标的和为定值，直接用公式；若下指标的差为定值，反转下标再用公式。
  
    $$
    \sum_{i=0}^{\min(n,m-k)}\binom{n}{i}\binom{m}{i+k}=\binom{n+m}{n+k}
    $$
  
    平方求和：
    
    $$
    \sum_{i=0}^n\binom{n}{i}^2=\binom{2n}{n}
    $$

- 上指标卷积：
  $$
  \sum_{i=0}^n\binom{i}{a}\binom{n-i}{b}=\binom{n+1}{a+b+1}
  $$

  > 证明：“$n$ 个物品分成左右两部分，左边选 $a$ 个，右边选 $b$ 个”，等价于插入一个分隔符，$n+1$ 个物品里选 $a+b+1$ 个（第 $a+1$ 个表示分隔符）。
  
- 吸收恒等式：
  
  $$
  \binom n m=\frac{n}{m}\binom{n-1}{m-1}\\
  m\binom{n}{m}=n\binom{n-1}{m-1}
  $$
  
  可用于上下指标同时 $\pm 1$。
  
  $$
  \binom n m=\frac n m\binom{n-1}{m-1}=\frac{m+1}{n+1}\binom{n+1}{m+1}
  $$
  
  推广：
  
  $$
  \binom{n}{m}\binom{m}{k}=\binom{n}{k}\binom{n-k}{m-k}=\binom{n+m+k}{n,m,k}
  $$
  
- 相伴恒等式：

  1. $$
     (n-m)\binom{n}{m}=n\binom{n-1}{m}\\
     \binom{n}{m}=\frac{n}{n-m}\binom{n-1}{m}
     $$
  2. $$
     m\binom{n}{m}=(n-m+1)\binom{n}{m-1}\\
     \binom{n}{m}=\frac{n-m+1}{m}\binom{n}{m-1}
     $$

  > 证明：
  >
  > 注意到吸收恒等式中 $n-m=(n-1)-(m-1)$，反转下指标就能使只有上指标 $-1$ 了。
  > 
  > $$
  > \binom{n}{m}=\frac{n}{m}\binom{n-1}{m-1}\Rightarrow \binom{n}{n-m}=\frac{n}{m}\binom{n-1}{n-m}\\
  > $$
  > 
  > 那么先上下指标同时 $-1$，再上指标 $+1$，就是只有下指标 $-1$ 了。
  > 
  > $$
  > m\binom{n}{m}=n\binom{n-1}{m-1}=n\times \frac{n-m+1}{n}\binom{n}{m-1}
  > $$

  可分别用于上指标 $\pm 1$、下指标 $\pm 1$。

- 上升幂与下降幂的转化：

    $$
    n^{\overline m}=(-1)^m(-n)^{\underline m}=(n+m-1)^{\underline m}\\
    n^{\underline m}=(-1)^m(-n)^{\overline m}=(n-m+1)^{\overline m}
    $$

- 上指标反转：
  $$
  \binom{n}{m}=(-1)^m\binom{-n+m-1}{m}
  $$

  > 证明：广义二项式系数。
  > 
  > $$
  > \frac{n(n-1)\cdots(n-m+1)}{m!}=(-1)^m\frac{(-n)(-n+1)\cdots(-n+m-1)}{m!}=(-1)^m\binom{-n+m-1}{m}
  > $$

- 上升幂与下降幂的转化 & 阶乘幂反转：
  
    $$
    n^{\underline m}=(-1)^m(-n)^{\overline m}=(-1)^m(-n+m-1)^{\underline m}\\
    n^{\overline m}=(-1)^m(-n)^{\underline m}=(-1)^m(-n-m+1)^{\overline m}
    $$

### 组合数的小性质

- 若 $p$ 为质数，则 $\forall m\in[1,p)$ 均有 $p\mid \large\binom{p}{m}$。

  > 证明：
  > 
  > $$
  > m!\mid p(p-1)\cdots(p-m+1)\\
  > m<p\land p\in\text{prime}\Rightarrow \gcd(m!,p)=1\Rightarrow m!\mid (p-1)\cdots(p-m+1)\\
  > \binom{p}{m}=p\frac{(p-1)\cdots(p-m+1)}{m!}
  > $$

### 一些定理

- Kummer 定理：$\large\binom{n+m}{m}$ 中质因子 $p$ 的幂次为 $n,m$ 在 $p$ 进制下相加的进位次数。

  > 证明：$x!$ 中 $p$ 的次数为 $\sum_{i\geq 1}\lfloor\frac{x}{p^i}\rfloor$。
  >
  > 考虑 $\lfloor\frac{x}{p^i}\rfloor$ 就是 $x$ 在 $p$ 进制下砍掉后面的 $0\sim i-1$ 位。考虑第 $i$ 位的贡献 $\lfloor\frac{n+m}{p^i}\rfloor-\lfloor\frac{n}{p^i}\rfloor-\lfloor\frac{m}{p^i}\rfloor$，思考“加起来再砍”和“砍掉再加”，可得贡献为 $1$ 当且仅当 $n+m$ 过程中第 $i-1$ 位进位到第 $i$ 位，否则贡献为 $0$。

  用来算质因子 $p$ 在组合数中的幂次。

  推广：$\displaystyle\binom{\sum_{i=1}^k {x_i}}{x_1,x_2,\cdots,x_k}$ 中质因子 $p$ 的幂次为 $x_1+x_2+\cdots+x_k$ 在 $p$ 进制下相加的进位次数。

  ZR#371、Gym102586E 中：$\displaystyle\binom{\sum_{i=1}^k x_i}{x_1,x_2,\cdots,x_k}\equiv 1\pmod 2$ 等价于，对于二进制下的每一位，所有 $x_i$ 中这位为 $1$ 的至多一个，即把 $\sum_{i=1}^k x_i$ 二进制下的每个 $1$ 分给 $x_i$。因为根据 Kummer 定理，不含 $2$ 的幂次所以不能有进位。

- Raney 引理：对于整数序列 $x_{1\sim n}$ 满足 $\sum_{i=1}^n x_i=1$，其所有循环移位中恰好有一个满足所有前缀和都 $\geq 1$。

  > 证明：将前缀和画成一条 $(0,0)\leadsto (n,1)$ 的折线，只能以“最后面的最低点”的后一位作为起点，使得其他最低点跨过序列末尾，前缀和为 $1$（若以前面的最低点的后一位为起点，会出现前缀和为 $0$）。

  也就是说，给出 $x_{1\sim n}$ 满足 $\sum_{i=1}^n x_i=1$，那么满足所有前缀和 $\geq 1$ 的排列数量（值相同的数之间区分），就是所有圆排列的数量 $(n-1)!$，因为每个圆排列（环）都只有一条链满足条件。

  - 可以用来证明卡特兰数的通项：

    “有多少 $n$ 个 $1$ 和 $n$ 个 $-1$ 组成的序列满足任意前缀和 $\geq 0$”，在序列最前面放一个 $1$，这样所有数和为 $1$ 且前缀和 $\geq 0$ 转化为了 $\geq 1$，就可以用 Raney 引理了。

    第一位的前缀和也要 $\geq 1$ 说明合法串的第一位一定是 $1$，这方便我们拆掉后来加的那个 $1$。

    1. 总共有 $\binom{2n+1}{n}$ 种 $n+1$ 个 $1$ 和 $n$ 个 $-1$ 的序列，同个循环同构等价类中只有一个串满足任意前缀和 $\geq 1$，且这个串第一位肯定是 $1$，每个合法串掉第一个 $1$ 都唯一对应一个合法括号序列，所以答案为 $\large\frac{\binom{2n+1}{n}}{2n+1}=\frac{\binom{2n}{n}}{n+1}$。

    2. 先考虑 $1,1,1,-1,-1,\cdots$（$n+1$ 个 $1$，$n$ 个 $-1$）有多少排列（$1$  之间区分，$-1$ 之间区分）满足前缀和 $\geq 1$：合法排列数 = 圆排列数 = $\frac{(2n+1)!}{2n+1}=(2n)!$，且第一位一定是 $1$。

       计算括号序列时 $1$ 之间是不区分的，$-1$ 之间也是不区分的，所以答案为 $\frac{(2n)!}{(n+1)!n!}$。想象那一堆不区分的 $1$ 中的第一个就是后来新加的 $1$。

  - 给出 $a_{1\sim m}$ 满足 $\sum_{i=1}^m a_i=0$ 且 $\min_{i=1}^m a_i\geq -1$，假设其中有 $x$ 个 $-1$，求有多少种排列（共 $m!$ 种排列）满足任意前缀和 $\geq 0$：

    此时不能在最前面放 $1$ 了，因为不能保证同个循环同构等价类中满足条件的那个串的第一位是 $1$，可能有 $>1$ 的数会抢走 $1$ 最前端的位置，没法拆掉这个 $1$ 得到原始问题的答案。

    一个很巧妙的方法是，前缀和 $\geq 0$ $\Leftrightarrow$ 后缀和 $\leq 0$，将序列 reverse 并取相反数变成了 $\max_{i=1}^m a_i\leq 1$ 的条件下前缀和 $\geq 0$ ，此时能直接在最开头加 $1$ 了。合法排列数 = 圆排列数 = $\frac{(m+1)!}{m+1}=m!$。

    其中只有 $\frac{x!}{(x+1)!}=\frac{1}{x+1}$ 种方案满足第一位的 $1$ 是后来新加的 $1$，所以答案为 $\frac{m!}{x+1}$。

    （P6672 [清华集训2016] 你的生命已如风中残烛）